@page "/payment/{OrderId:int}"
@using Microsoft.AspNetCore.Components
@using Microsoft.EntityFrameworkCore
@using MakanGoFood.Domain
@using MakanGoFood.Data

@inject IDbContextFactory<MakanGoFoodContext> DbFactory
@inject NavigationManager Nav

@rendermode InteractiveServer

<h3>Payment</h3>

@if (loading)
{
    <p><em>Loading...</em></p>
}
else if (order is null)
{
    <div class="alert alert-danger">Order not found.</div>
    <button class="btn btn-secondary" @onclick='() => Nav.NavigateTo("/myorders")'>Back</button>
}
else
{
    <div class="card p-3">
        <p><b>Order ID:</b> @order.OrderId</p>
        <p><b>Total:</b> @order.OrderTotal.ToString("0.00")</p>
        <p><b>Order Status:</b> @order.OrderStatus</p>

        @if (payment is null)
        {
            <div class="alert alert-warning">No payment record found for this order.</div>
            <button class="btn btn-secondary" @onclick='() => Nav.NavigateTo("/myorders")'>Back</button>
        }
        else
        {
            <p><b>Payment Method:</b> @payment.PaymentMethod</p>
            <p><b>Payment Status:</b> @payment.PaymentStatus</p>

            @if (payment.PaymentStatus != "Paid")
            {
                <div class="d-flex gap-2 mt-2">
                    <button class="btn btn-success" @onclick="PayNow">Pay Now (Simulate)</button>
                    <button class="btn btn-outline-secondary" @onclick='() => Nav.NavigateTo("/myorders")'>Pay Later</button>
                </div>
            }
            else
            {
                <div class="alert alert-success mt-2">
                    Payment completed ✅ Transaction: @payment.TransactionRef
                </div>
                <button class="btn btn-primary" @onclick='() => Nav.NavigateTo("/myorders")'>Go to My Orders</button>
            }
        }
    </div>
}

@code {
    [Parameter] public int OrderId { get; set; }

    private bool loading = true;
    private Order? order;
    private Payment? payment;

    protected override async Task OnInitializedAsync()
    {
        await Load();
    }

    private async Task Load()
    {
        loading = true;
        using var db = DbFactory.CreateDbContext();

        order = await db.Order.AsNoTracking().FirstOrDefaultAsync(o => o.OrderId == OrderId);
        payment = await db.Payment.AsNoTracking().FirstOrDefaultAsync(p => p.OrderId == OrderId);

        loading = false;
    }

    private async Task PayNow()
    {
        using var db = DbFactory.CreateDbContext();

        var o = await db.Order.FirstOrDefaultAsync(x => x.OrderId == OrderId);
        var p = await db.Payment.FirstOrDefaultAsync(x => x.OrderId == OrderId);

        if (o is null || p is null) return;

        p.PaymentStatus = "Paid";
        p.PaidAt = DateTime.UtcNow;
        p.TransactionRef = $"SIM-{Guid.NewGuid():N}".Substring(0, 12);

        o.OrderStatus = "Paid"; // or "Confirmed"

        await db.SaveChangesAsync();
        await Load();
    }
}
