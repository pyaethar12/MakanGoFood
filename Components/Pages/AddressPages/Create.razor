@page "/addresses/create"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.EntityFrameworkCore
@using MakanGoFood.Data
@using MakanGoFood.Domain

@inject IDbContextFactory<MakanGoFoodContext> DbFactory
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Nav

@rendermode InteractiveServer
@attribute [Authorize(Roles = "Customer")]

<PageTitle>Create Address</PageTitle>

<h1>Create Address</h1>

@if (!string.IsNullOrWhiteSpace(errorMsg))
{
    <div class="alert alert-danger">@errorMsg</div>
}

<EditForm Model="address" OnValidSubmit="CreateAddress">
    <DataAnnotationsValidator />
    <ValidationSummary class="text-danger" />

    <div class="mb-3">
        <label class="form-label">Street</label>
        <InputText class="form-control" @bind-Value="address.Street" />
    </div>

    <div class="mb-3">
        <label class="form-label">City</label>
        <InputText class="form-control" @bind-Value="address.City" />
    </div>

    <div class="mb-3">
        <label class="form-label">Postal Code</label>
        <InputText class="form-control" @bind-Value="address.PostalCode" />
    </div>

    <button type="submit" class="btn btn-primary">Create</button>
    <a class="btn btn-outline-secondary ms-2" href="/addresses">Back</a>
</EditForm>

@code {
    private Address address = new();
    private string? errorMsg;

    private async Task CreateAddress()
    {
        errorMsg = null;

        var auth = await AuthStateProvider.GetAuthenticationStateAsync();
        var email = auth.User.Identity?.Name;

        if (string.IsNullOrWhiteSpace(email))
        {
            errorMsg = "Not logged in.";
            return;
        }

        using var db = DbFactory.CreateDbContext();

        var customer = await db.Customer.FirstOrDefaultAsync(c => c.Email == email);
        if (customer is null)
        {
            errorMsg = "Customer profile not found. Please register/login again.";
            return;
        }

        // ✅ Auto-set CustomerId
        address.CustomerId = customer.CustomerId;

        db.Address.Add(address);
        await db.SaveChangesAsync();

        Nav.NavigateTo("/addresses");
    }
}
