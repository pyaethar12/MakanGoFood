@page "/myorders/{OrderId:int}"

@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.EntityFrameworkCore
@using MakanGoFood.Data
@using MakanGoFood.Domain

@inject IDbContextFactory<MakanGoFoodContext> DbFactory
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Nav

@rendermode InteractiveServer
@attribute [Authorize(Roles = "Customer")]

<h1>Order Details</h1>

@if (!string.IsNullOrWhiteSpace(error))
{
    <div class="alert alert-danger">@error</div>
}

@if (order is null)
{
    <p>Loading...</p>
}
else
{
    <div class="mb-3">
    <p><b>Order ID:</b> @order.OrderId</p>
    <p><b>Date:</b> @order.OrderDateTime</p>

    <p><b>Status:</b> @order.OrderStatus</p>
    <OrderStatusTimeline CurrentStatus="@order.OrderStatus" />

    <p><b>Restaurant:</b> @order.Restaurant?.Name</p>
    <p><b>Deliver to:</b>
        @($"{order.Address?.Street}, {order.Address?.City} ({order.Address?.PostalCode})")
    </p>
</div>


    @if (items.Count == 0)
    {
        <p>No items found for this order.</p>
    }
    else
    {
        <table class="table">
            <thead>
                <tr>
                    <th>Item</th>
                    <th style="width:120px;">Qty</th>
                    <th style="width:120px;">Price</th>
                    <th style="width:140px;">Subtotal</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var i in items)
                {
                    <tr>
                        <td>@i.Menu?.Name</td>
                        <td>@i.Quantity</td>
                        <td>@(i.Menu?.Price.ToString("0.00"))</td>
                        <td>@i.Subtotal.ToString("0.00")</td>
                    </tr>
                }
            </tbody>
        </table>

        <p class="mt-3"><b>Total: @total.ToString("0.00")</b></p>
    }

    <button class="btn btn-outline-secondary"
            @onclick="@(() => Nav.NavigateTo("/myorders"))">
        Back to My Orders
    </button>

}

@code {
    [Parameter] public int OrderId { get; set; }

    private Order? order;
    private List<OrderItem> items = new();
    private decimal total = 0;
    private string? error;

    protected override async Task OnInitializedAsync()
    {
        using var db = DbFactory.CreateDbContext();

        // 1) Identify current customer by Identity email
        var auth = await AuthStateProvider.GetAuthenticationStateAsync();
        var email = auth.User.Identity?.Name;

        if (string.IsNullOrWhiteSpace(email))
        {
            error = "Not logged in.";
            return;
        }

        var customer = await db.Customer.FirstOrDefaultAsync(c => c.Email == email);
        if (customer is null)
        {
            error = "Customer record not found.";
            return;
        }

        // 2) Load the order, but ONLY if it belongs to this customer (security)
        order = await db.Order
            .Include(o => o.Restaurant)
            .Include(o => o.Address)
            .FirstOrDefaultAsync(o => o.OrderId == OrderId && o.CustomerId == customer.CustomerId);

        if (order is null)
        {
            error = "Order not found (or you don't have access).";
            return;
        }

        // 3) Load items for that order + include menu
        items = await db.OrderItem
            .Include(oi => oi.Menu)
            .Where(oi => oi.OrderId == OrderId)
            .AsNoTracking()
            .ToListAsync();

        total = items.Sum(i => i.Subtotal);
    }
}
